<!DOCTYPE HTML>
<html>
	<head>
		<title>修改密码 - Password Change - Timing</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="icon" type="image/x-icon" href="assets/favicon.ico">
		<link rel="icon" type="image/png" sizes="32x32" href="assets/favicon.png">
		<link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
		<link rel="stylesheet" href="assets/css/main.css" />
		<link rel="stylesheet" href="assets/css/navigation.css" />
		<link rel="stylesheet" href="assets/css/user-settings-style.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>

	<body class="is-preload">
		<!-- Navigation will be loaded dynamically -->

		<!-- Wrapper -->
		<div id="wrapper">

		<!-- Main Settings Container -->
		<div class="settings-container">
			<div class="settings-content">
				<a class="back-btn" href="javascript:goBack()">←</a>
				
				<h1 class="settings-title" id="settings-title">修改密码</h1>
				<p class="settings-subtitle" id="settings-subtitle">修改您的登录密码</p>
				
				<form id="passwordForm">
					<!-- Password Section -->
					<div class="form-group">
						<label for="currentPassword" id="current-password-label">当前密码</label>
						<input type="password" id="currentPassword" name="currentPassword" class="form-input" placeholder="请输入当前密码以确认修改">
					</div>
					
					<div class="form-group">
						<label for="newPassword" id="new-password-label">新密码</label>
						<input type="password" id="newPassword" name="newPassword" class="form-input" placeholder="请输入新密码（至少6个字符）">
					</div>
					
					<div class="form-group">
						<label for="confirmPassword" id="confirm-password-label">确认新密码</label>
						<input type="password" id="confirmPassword" name="confirmPassword" class="form-input" placeholder="请再次输入新密码">
					</div>

					<!-- Buttons -->
					<div class="button-group">
						<button type="button" class="form-btn form-cancel-btn" onclick="cancelChanges()" id="cancel-btn">取消</button>
						<button type="submit" class="form-btn form-save-btn" id="save-btn">确认保存</button>
					</div>
				</form>
			</div>
		</div>

		</div>

		<!-- BG -->
		<div id="bg"></div>

		<!-- Scripts -->
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>
		<script src="assets/js/navigation-loader.js"></script>
		<script src="assets/js/navigation.js"></script>

		<script>
			// Language configuration
			const translations = {
				zh: {
					title: '修改密码',
					subtitle: '修改您的登录密码',
					currentPasswordLabel: '当前密码',
					currentPasswordPlaceholder: '请输入当前密码以确认修改',
					newPasswordLabel: '新密码',
					newPasswordPlaceholder: '请输入新密码（至少6个字符）',
					confirmPasswordLabel: '确认新密码',
					confirmPasswordPlaceholder: '请再次输入新密码',
					cancelBtn: '取消',
					saveBtn: '确认保存',
					loginRequired: '请先登录！',
					currentPasswordRequired: '请输入当前密码',
					newPasswordRequired: '请输入新密码',
					passwordTooShort: '新密码至少需要6个字符',
					passwordMismatch: '新密码与确认密码不一致',
					updateSuccess: '密码修改成功！',
					updateError: '密码修改失败：',
					unsavedChanges: '您有未保存的修改，确定要取消吗？'
				},
				en: {
					title: 'Change Password',
					subtitle: 'Change your login password',
					currentPasswordLabel: 'Current Password',
					currentPasswordPlaceholder: 'Enter current password to confirm changes',
					newPasswordLabel: 'New Password',
					newPasswordPlaceholder: 'Enter new password (at least 6 characters)',
					confirmPasswordLabel: 'Confirm New Password',
					confirmPasswordPlaceholder: 'Re-enter new password',
					cancelBtn: 'Cancel',
					saveBtn: 'Save Changes',
					loginRequired: 'Please login first!',
					currentPasswordRequired: 'Please enter your current password',
					newPasswordRequired: 'Please enter a new password',
					passwordTooShort: 'New password must be at least 6 characters long',
					passwordMismatch: 'New password and confirmation do not match',
					updateSuccess: 'Password updated successfully!',
					updateError: 'Password update failed: ',
					unsavedChanges: 'You have unsaved changes, are you sure you want to cancel?'
				}
			};

			// Current language and original data
			let currentLanguage = window.NavigationConfig.detectLanguage();
			let hasPasswordChanges = false;

			// Initialize page
			document.addEventListener('DOMContentLoaded', function() {
				// Detect language from URL parameter
				const urlParams = new URLSearchParams(window.location.search);
				const lang = urlParams.get('lang');
				if (lang === 'en') {
					currentLanguage = 'en';
				}

				// Check if user is logged in
				if (!isUserLoggedIn()) {
					alert(translations[currentLanguage].loginRequired);
					redirectToLogin();
					return;
				}

				// Set initial language
				updateLanguage();

				// Setup form validation
				setupFormValidation();

				// Setup navigation handling for password change page
				setupPasswordChangeNavigation();

				// Track password changes
				setupChangeTracking();
			});

			// Check if user is logged in
			function isUserLoggedIn() {
				const userRegistered = localStorage.getItem('userRegistered');
				const userInfo = localStorage.getItem('userInfo');
				return userRegistered === 'true' && userInfo;
			}

			// Redirect to login page
			function redirectToLogin() {
				const loginPage = currentLanguage === 'en' ? 'login.html?lang=en' : 'login.html?lang=zh';
				window.location.href = loginPage;
			}

			// Update page language
			function updateLanguage() {
				const t = translations[currentLanguage];
				
				document.getElementById('settings-title').textContent = t.title;
				document.getElementById('settings-subtitle').textContent = t.subtitle;
				document.getElementById('current-password-label').textContent = t.currentPasswordLabel;
				document.getElementById('currentPassword').placeholder = t.currentPasswordPlaceholder;
				document.getElementById('new-password-label').textContent = t.newPasswordLabel;
				document.getElementById('newPassword').placeholder = t.newPasswordPlaceholder;
				document.getElementById('confirm-password-label').textContent = t.confirmPasswordLabel;
				document.getElementById('confirmPassword').placeholder = t.confirmPasswordPlaceholder;
				document.getElementById('cancel-btn').textContent = t.cancelBtn;
				document.getElementById('save-btn').textContent = t.saveBtn;
			}

			// Setup form validation
			function setupFormValidation() {
				const form = document.getElementById('passwordForm');
				
				// Form submission
				form.addEventListener('submit', function(e) {
					e.preventDefault();
					handleFormSubmission();
				});
			}

			// Handle form submission
			function handleFormSubmission() {
				// Validate form
				if (!validateForm()) {
					return;
				}

				try {
					// Here you would normally send to server
					// For now, just simulate success
					alert(translations[currentLanguage].updateSuccess);
					hasPasswordChanges = false;
					goBack();
				} catch (error) {
					console.error('Password update failed:', error);
					alert(translations[currentLanguage].updateError + error.message);
				}
			}

			// Validate form
			function validateForm() {
				const t = translations[currentLanguage];
				const currentPassword = document.getElementById('currentPassword').value;
				const newPassword = document.getElementById('newPassword').value;
				const confirmPassword = document.getElementById('confirmPassword').value;

				// Required fields
				if (!currentPassword) {
					alert(t.currentPasswordRequired);
					document.getElementById('currentPassword').focus();
					return false;
				}

				if (!newPassword) {
					alert(t.newPasswordRequired);
					document.getElementById('newPassword').focus();
					return false;
				}

				if (newPassword.length < 6) {
					alert(t.passwordTooShort);
					document.getElementById('newPassword').focus();
					return false;
				}

				if (newPassword !== confirmPassword) {
					alert(t.passwordMismatch);
					document.getElementById('confirmPassword').focus();
					return false;
				}

				return true;
			}

			// Setup change tracking
			function setupChangeTracking() {
				const inputs = ['currentPassword', 'newPassword', 'confirmPassword'];
				inputs.forEach(inputId => {
					document.getElementById(inputId).addEventListener('input', function() {
						hasPasswordChanges = true;
					});
				});
			}

			// Cancel changes
			function cancelChanges() {
				const t = translations[currentLanguage];
				if (hasPasswordChanges) {
					if (confirm(t.unsavedChanges)) {
						goBack();
					}
				} else {
					goBack();
				}
			}

			// Go back to user settings
			function goBack() {
				const langParam = '?lang=' + currentLanguage;
				window.location.href = 'user-settings.html' + langParam;
			}

			// Setup navigation handling for password change page
			function setupPasswordChangeNavigation() {
				// Wait for navigation to be loaded
				function handlePasswordChangeNavigation() {
					// Override navigation clicks to go to home page with section
					document.querySelectorAll('.nav-item').forEach(function(item) {
						const navId = item.getAttribute('data-nav-id');
						const href = item.getAttribute('href');
						
						// Only handle section navigation links (starting with #)
						if (href && href.startsWith('#')) {
							item.addEventListener('click', function(e) {
								e.preventDefault();
								
								// Get the target section
								const sectionId = href.substring(1);
								
								// Navigate to home page with section
								const homePage = currentLanguage === 'en' ? 'index.html' : 'index-zh.html';
								window.location.href = homePage + '#' + sectionId;
							});
						}
					});
				}

				// Wait for navigation to be loaded
				if (document.querySelector('.top-navigation')) {
					handlePasswordChangeNavigation();
				} else {
					document.addEventListener('navigationLoaded', handlePasswordChangeNavigation);
				}
			}

			// Handle beforeunload to warn about unsaved changes
			window.addEventListener('beforeunload', function(e) {
				if (hasPasswordChanges) {
					e.preventDefault();
					e.returnValue = '';
				}
			});
		</script>
	</body>
</html> 